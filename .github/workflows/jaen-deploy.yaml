# SPDX-FileCopyrightText: Copyright ¬© 2021 snek.at
# SPDX-License-Identifier: EUPL-1.2
#
# Use of this source code is governed by an EUPL-1.2 license that can be found
# in the LICENSE file at https://snek.at/license

# https://help.github.com/en/articles/workflow-syntax-for-github-actions#name
name: Deploy Jaen

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency: 
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Default to bash
defaults:
  run:
    shell: bash

# https://help.github.com/en/articles/workflow-syntax-for-github-actions#on
on:
  # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_call
  workflow_call:
    # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecrets
    secrets:
      CLOUDFLARE_ACCOUNT_ID:
        description: Cloudflare account id.
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false
      CLOUDFLARE_API_TOKEN:
        description: Cloudflare api key.
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false
      SCALE_SERP_APIKEY:
        description: Scale Serp api key.
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false
      SCALE_SERP_GOOGLE_PLACE_ID:
        description: Place IDs uniquely identify a place in the Google Places database and on Google Maps.
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false
      GATSBY_MYSHOPIFY_URL:
        description: Domain for a Shopify shop (foo.myshopify.com).
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false
      GATSBY_STOREFRONT_API_KEY:
        description: Key for Shopify Storefront API.
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false
      SHOPIFY_APP_PASSWORD:
        description: Personal access token for a Shopify account.
        required: false
      SENDGRID_API_KEY:
        description: SendGrid api key.
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false
      GATSBY_MAPBOX_ACCESS_TOKEN:
        description: Mapbox access token.
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false
      GATSBY_SNEK_FUNCTION_URL:
        description: URL of the Snek function.
        # https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecretssecret_idrequired
        required: false

env:
 NODE_OPTIONS: --max-old-space-size=8192

# https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobs
jobs:
  # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_id
  jaen-deploy:
    # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idruns-on
    runs-on: macos-latest

    defaults:
      run:
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#
        working-directory: ${{ github.event.client_payload.cwd || '.' }}

    # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idsteps
    steps:
      # https://github.com/actions/checkout
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepswith
        with:
          # Relative path under $GITHUB_WORKSPACE to place the repository
          path: "."
          # The branch, tag or SHA to checkout. When checking out the repository that
          # triggered a workflow, this defaults to the reference or SHA for that event.
          # Otherwise, uses the default branch.
          ref: "main"

      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/yarn.lock" ]; then
            echo "::set-output name=manager::yarn"
            echo "::set-output name=command::install"
            exit 0
          elif [ -f "${{ github.workspace }}/package.json" ]; then
            echo "::set-output name=manager::npm"
            echo "::set-output name=command::ci"
            exit 0
          else
            echo "Unable to determine packager manager"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: ${{ steps.detect-package-manager.outputs.manager }}

      # https://dev.to/mpocock1/how-to-cache-nodemodules-in-github-actions-with-yarn-24eh
      - name: Yarn Cache Directory Path
        id: yarn-cache-dir-path
        # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstepsrun
        run: echo "::set-output name=dir::$(yarn cache dir)"

      # https://github.com/marketplace/actions/cache
      - name: Yarn Cache Folder
        uses: actions/cache@v3
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepswith
        with:
          # https://help.github.com/en/articles/virtual-environments-for-github-actions#default-environment-variables
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # https://github.com/marketplace/actions/cache
      - name: Yarn Cache Node
        uses: actions/cache@v3
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepswith
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

#       # https://github.com/marketplace/actions/cache
#       - name: Gatsby Cache Folder
#         uses: actions/cache@v3
#         # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepswith
#         with:
#           key: gatsby-cache-folder
#           path: .cache

      # https://github.com/marketplace/actions/cache
      - name: Gatsby Public Folder
        uses: actions/cache@v3
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepswith
        with:
          key: gatsby-public-folder
          path: public

      # https://classic.yarnpkg.com/lang/en/docs/cli/install/#toc-yarn-install-pure-lockfile
      - name: Yarn Install
        # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstepsrun
        run: yarn install --pure-lockfile

      # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstepsid
      - name: Setup Pages üîß
        id: pages
        uses: actions/configure-pages@v2
        with:
          # Automatically inject pathPrefix in your Gatsby configuration file.
          #
          # You may remove this line if you want to manage the configuration yourself.
          static_site_generator: gatsby

      # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstepsid
      - name: Build with Gatsby üõ†Ô∏è
        # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstepsrun
        run:
          ${{ steps.detect-package-manager.outputs.manager }} run build
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsenv
        env:
          PREFIX_PATHS: 'true'
          GATSBY_MYSHOPIFY_URL:  ${{ secrets.GATSBY_MYSHOPIFY_URL }}
          GATSBY_STOREFRONT_API_KEY:  ${{ secrets.GATSBY_STOREFRONT_API_KEY }}
          SHOPIFY_APP_PASSWORD:  ${{ secrets.SHOPIFY_APP_PASSWORD }}
          SCALE_SERP_APIKEY: ${{ secrets.SCALE_SERP_APIKEY }}
          SCALE_SERP_GOOGLE_PLACE_ID: ${{ secrets.SCALE_SERP_GOOGLE_PLACE_ID }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          GATSBY_MAPBOX_ACCESS_TOKEN: ${{ secrets.GATSBY_MAPBOX_ACCESS_TOKEN }}
    
      # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstepsid
      - name: Deploy Cloudflare Pages üöÄ
        # See: https://github.com/cloudflare/pages-action
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: snek
          directory: ./public
          # Optional: Specify the Wrangler version
          wranglerVersion: '3'
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsenv
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
